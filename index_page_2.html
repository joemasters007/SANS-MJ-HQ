<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HeroQuest â€” Page 2</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Uncial+Antiqua&display=swap" rel="stylesheet"/>

<style>
:root{
  --bg:#0c0c0f;
  --fg:#f2e9de;
  --edge:#5f4a35;
  --gold:#d9b66f;
  --card:#141418;
  --ink:#1a1a20;
  --gap:6px;
}
*{ box-sizing:border-box }
html,body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
}
.hq{ font-family:'Cinzel Decorative','Uncial Antiqua',serif; }
.btn{
  background:var(--ink);
  border:1px solid var(--edge);
  color:var(--fg);
  padding:6px 10px;
  border-radius:10px;
}
#page2{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:8px;
}
.topbar{ display:flex; align-items:center; gap:8px; }
.topbar .spacer{ flex:1 }
.content{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.panel{
  background:var(--card);
  border:1px solid var(--edge);
  border-radius:12px;
  padding:8px;
}
.subgrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-bottom:8px;
}
.tile{
  position:relative;
  border:1px solid var(--edge);
  border-radius:12px;
  background:#0f0f13;
  height:364px;
}
.tile .title{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,.6);
  border:1px solid var(--edge);
  border-radius:8px;
  padding:4px 8px;
}
.separator{
  display:flex;
  align-items:center;
  gap:10px;
  margin:6px 0;
}
.separator::before,
.separator::after{
  content:"";
  flex:1;
  height:1px;
  background:linear-gradient(to right, transparent, var(--gold), transparent);
}
.separator span{
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  color:var(--gold);
  font-size:13px;
  letter-spacing:2px;
}
.unit{
  aspect-ratio:5/4;
  border:1px solid var(--edge);
  border-radius:6px;
  background:#111;
  display:flex;
  align-items:center;
  justify-content:center;
}
.unit img{
  max-width:100%;
  max-height:100%;
}
.enemy-grid,
.hero-grid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:var(--gap);
}
.right-panel{
  height:100%;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.right-plan{
  flex:1;
  border:1px solid var(--edge);
  border-radius:12px;
  background:#0f0f13;
}
.right-small{
  height:121px;
  border:1px solid var(--edge);
  border-radius:12px;
  background:#0f0f13;
  display:flex;
  flex-direction:column;
  padding:4px;
}
.rs-top{ flex:2 }
.rs-bottom{ flex:1 }
#hero-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.hero-box{
  width:520px;
  background:#141418;
  border:1px solid var(--edge);
  border-radius:12px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.hero-grid-select{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
.hero-choice{
  border:1px solid var(--edge);
  border-radius:8px;
  padding:8px 4px;
  text-align:center;
  cursor:pointer;
}
.hero-choice.selected{
  color:var(--gold);
  border-color:var(--gold);
  background:rgba(217,182,111,.15);
}

/* ===== CADRE DORÃ‰ (tour actif) ===== */
.gold{
  outline:3px solid var(--gold);
  outline-offset:-3px;
}


/* ===== NOUVEAU TOUR (AU-DESSUS DU 5e CADRE) ===== */
.enemy-grid-wrapper{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:var(--gap);
}
.enemy-grid-wrapper .new-turn-spacer{
  grid-column:1 / span 4;
}
.enemy-grid-wrapper .new-turn-label{
  grid-column:5;
  text-align:center;
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  color:var(--gold);
  font-size:11px;
  letter-spacing:1px;
}
.enemy-grid{
  grid-column:1 / span 5;
}


/* ===== DÃ‰ DE SAUVEGARDE ===== */
.save-box{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  gap:4px;
  font-size:12px;
}
.save-title{
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  color:var(--gold);
  font-size:11px;
  letter-spacing:1px;
}
.save-controls{
  display:flex;
  align-items:center;
  gap:6px;
}
.save-controls button{
  width:33px;
  height:33px;
  padding:0;
  border-radius:6px;
  background:var(--ink);
  border:1px solid var(--edge);
  color:var(--fg);
  cursor:pointer;
  font-size:18px;
}
.save-count{
  font-size:33px;
  font-weight:700;
  min-width:42px;
  text-align:center;
}







/* ===== FIX IMAGE PIÃˆGE DANS SON CADRE ===== */
.save-box{
  position:relative;
  overflow:hidden;          /* interdit tout dÃ©bordement */
}

.save-box .save-controls{
  display:flex;
  align-items:center;
  gap:6px;
}

.save-box .save-title{
  z-index:2;
}

.save-box img.save-piege{
  position:absolute;
  bottom:4px;
  left:50%;
  transform:translateX(-50%);
  max-width:90%;
  max-height:45%;
  object-fit:contain;
  z-index:1;                /* derriÃ¨re le texte/compteur */
  pointer-events:none;
}


.save-box img.save-piege{
  position:absolute;
  bottom:4px;
  left:50%;
  transform:translateX(-50%);
  max-width:90%;
  max-height:45%;
  object-fit:contain;
  pointer-events:none;
}

.save-title,
.save-controls{
  position:relative;
  z-index:2;                    /* toujours au-dessus de lâ€™image */
}


/* ===== IMAGE PIÃˆGE DANS LE CADRE (comme le dÃ©, mais en fond) ===== */
.save-box{
  position:relative;
  overflow:hidden;
  background-image:url("images/piege.jpg");
  background-repeat:no-repeat;
  background-position:center 75%;
  background-size:contain;
}
.save-title,
.save-controls{
  position:relative;
  z-index:2;
}


/* ===== RECHERCHE TRÃ‰SOR (AU-DESSUS DU 5e CADRE HÃ‰ROS) ===== */
.hero-grid-wrapper{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:var(--gap);
}
.hero-grid-wrapper .treasure-spacer{
  grid-column:1 / span 4;
}
.hero-grid-wrapper .treasure-label{
  grid-column:5;
  text-align:center;
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  color:var(--gold);
  font-size:11px;
  letter-spacing:1px;
}
.hero-grid{
  grid-column:1 / span 5;
}


/* ===== FIX IMAGES TUILES (MODE SOLO / Ã‰VÃ‰NEMENT) ===== */
.tile{
  position:relative;
  overflow:hidden;
}
.tile img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain; /* image bien cadrÃ©e, pas gÃ©ante */
  z-index:0;
}
.tile .title{
  z-index:2; /* titre toujours au-dessus de l'image */
}


/* ===== VISIBILITÃ‰ DÃ‰ DE SAUVEGARDE ===== */
.save-box{
  justify-content:space-between; /* titre en haut, compteur au milieu, image en bas */
}

.save-title{
  color:#000;                 /* noir pour lisibilitÃ© */
  background:rgba(217,182,111,.85);
  padding:2px 6px;
  border-radius:6px;
  margin-top:2px;
}


/* ===== NOTES / OBJECTIFS (sÃ©paration simple, sans cadre interne) ===== */
.notes-objectifs{
  display:grid;
  grid-template-columns:1fr 1fr;
  align-items:center;
  height:100%;
}
.no-head{
  text-align:center;
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  color:var(--gold);
  font-size:12px;
  letter-spacing:2px;
}
.no-left{
  border-right:1px solid var(--edge);
}


/* ===== RESTAURATION STYLE HEROQUEST BOUTONS TOPBAR ===== */
.topbar .hq-btn{
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  
  letter-spacing:2px;
  font-size:13px;
  padding:8px 18px;
  color:var(--gold);
  background:linear-gradient(180deg,#3a2f1f 0%,#1a140d 100%);
  border:1px solid var(--gold);
  border-radius:14px;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.18),
    0 0 10px rgba(217,182,111,.35);
  cursor:pointer;
}
.topbar .hq-btn:hover{
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.25),
    0 0 16px rgba(217,182,111,.6);
}


/* ===== MONSTRE ERRANT (CSV) ===== */
.monster-text{
  margin-top:8px;
  color:var(--gold);
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  font-size:13px;
  line-height:1.5;
}


/* ===== MONSTRE ERRANT (CSV) ===== */
.monster-text{
  margin-top:6px;
  text-align:center;
  color:var(--gold);
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  font-size:13px;
  line-height:1.5;
  white-space:pre-line;
}


/* ===== PREPARATION NOTES / OBJECTIFS ===== */
.notes-objectifs{
  align-items:flex-start;
}

.no-col{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}

.no-title{
  align-self:flex-start;
  margin:0;
  padding:2px 4px;
}

.slots{
  margin-top:6px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  min-height:32px;
}


/* ===== NOTES : LETTRES (CSV) ===== */
.note-square{

  width:24px;
  height:24px;
  border:1px solid var(--gold);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  font-size:13px;
  color:var(--gold);
  background:rgba(0,0,0,.3);
}



.objective-square{
  width:24px;
  height:24px;
  border:1px solid var(--gold);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:'Cinzel Decorative','Uncial Antiqua',serif;
  font-size:13px;
  color:var(--gold);
  background:rgba(0,0,0,.3);
  cursor:pointer;
}

/* ===== NOTE LUE (VERT TRANSPARENT HQ) ===== */
.note-square.read{
  background: rgba(46,167,84,.35);
  border-color: rgba(46,167,84,.9);
  color: var(--gold);
  box-shadow: inset 0 0 0 1px rgba(46,167,84,.35);
}


/* ===== OBJECTIFS : DÃ‰CALAGE Ã€ DROITE ===== */
#objectifs-title,
#objectifs-slots{
  margin-left: 20px;
}


/* ===== TEXTE NOTES STYLE HEROQUEST ===== */
.note-text{
  font-family:'Cinzel Decorative','Uncial Antiqua',serif !important;
  font-size:1.15em;
  letter-spacing:1px;
  line-height:1.6;
  text-align:justify;
  text-align-last:left;
  text-justify:inter-word;
  color:var(--gold);
}



/* ===== TEXTE MODALES UNIFIÃ‰ ===== */
.modal-text{
  font-family:'HeroQuestCustom', serif !important;
  font-size:1.9em;
  line-height:1.8;
  letter-spacing:0px;
  color:var(--gold);
  text-align:justify;
}

/* ===== HEROQUEST CUSTOM FONT ===== */
@font-face {
  font-family: 'HeroQuestCustom';
  src: url('heroquestcyrunicorn.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

/* Apply everywhere */
body,
button,
.note-text,
.no-head,
.separator span,
.save-title,
.topbar,
.hero-choice {
  font-family: 'HeroQuestCustom', serif !important;
  text-transform: none !important;
  letter-spacing: normal !important;
}


/* ===== OBJECTIF LU (BLEU HEROQUEST) ===== */
.objective-square.read-objective{
  background: rgba(70,130,255,.35);
  border-color: rgba(70,130,255,.9);
  color: var(--gold);
  box-shadow: inset 0 0 0 1px rgba(70,130,255,.35);
}


.objectif-open{
  box-shadow: 0 0 0 4px rgba(70,130,255,.8),
              0 0 25px rgba(70,130,255,.5);
  border-right:2px solid rgba(70,130,255,.9) !important;
}

#histoireClose:hover{
  background:rgba(217,182,111,.2);
}
</style>
</head>

<body>
<section id="page2">
  <div class="topbar">
    <button id="btn-histoire" class="btn hq-btn">ðŸ“œ Histoire de la quÃªte</button>
    <div class="spacer"></div>
    <button class="btn">RÃ¨gles</button>
    <button class="btn">Ã‰quipements</button>
    <button class="btn hq-btn" onclick="document.getElementById('fin-quete-modal').style.display='flex'">Fin de quÃªte</button>
  </div>

  <div class="content">
    <div>
      <div class="subgrid">
        <div class="tile"><div class="title hq">Mode Solo</div><img src="images/modesol.jpg" alt="Mode Solo"></div>
        <div class="tile"><div class="title hq">Ã‰vÃ©nement & piÃ¨ge</div><img src="images/event.jpg" alt="Ã‰vÃ©nement & piÃ¨ge"></div>
      </div>

      <div class="panel">
        <div class="separator"><span>ENNEMIS</span></div>
        <div class="enemy-grid-wrapper">
  <div class="new-turn-spacer"></div>
  <div class="new-turn-label">NOUVEAU TOUR</div>
  <div class="enemy-grid">
          <div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div>
          <div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div>
          </div>
  </div>

        <div class="separator"><span>HÃ‰ROS</span></div>
        <div class="hero-grid-wrapper">
          <div class="treasure-spacer"></div>
          <div class="treasure-label">RECHERCHE TRÃ‰SOR</div>
          <div class="hero-grid">
            <div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div><div class="unit"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel right-panel">
      <div class="right-plan"></div>
      <div class="right-small">
        <div class="rs-top notes-objectifs">
        <div class="no-col no-left">
          <div class="no-head no-title">NOTES</div>
          <div id="notes-slots" class="slots"></div>
        </div>
        <div class="no-col">
          <div class="no-head no-title">OBJECTIFS</div>
          <div id="objectifs-slots" class="slots"></div>
        </div>
      </div>
        <div class="separator"><span>MONSTRE ERRANT</span></div>
        <div class="rs-bottom">
  <div id="monster-text" class="monster-text"></div></div>
      </div>
    </div>
  </div>
</section>

<div id="hero-overlay">
  <div class="hero-box">
    <div class="hq">Choisissez 4 hÃ©ros</div>
    <div id="hero-select" class="hero-grid-select"></div>
  </div>
</div>

<script>
/* ===== ENNEMIS ===== */
const ENEMIES = ["ab","gc","gargouille","gobelin","orc","zombi","squelette","momie"];

/* cadres ennemis actifs : on ignore chaque 5e */
const enemySlots = [...document.querySelectorAll(".enemy-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

/* mÃ©lange */
ENEMIES.sort(()=>Math.random()-0.5);

/* placement */
enemySlots.forEach((slot,i)=>{
  slot.innerHTML = `<img src="images/${ENEMIES[i]}.jpg" alt="${ENEMIES[i]}">`;
});

/* ===== HEROES ===== */
fetch("heros.csv")
  .then(r=>r.text())
  .then(txt=>{
    const heroes = txt.trim().split("\n").slice(1)
      .map(l=>l.split(";")[0].trim());
    initHeroSelection(heroes);
  });

const heroSelect = document.getElementById("hero-select");
const overlay = document.getElementById("hero-overlay");
const heroGrid = [...document.querySelectorAll(".hero-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

function initHeroSelection(HEROES){
  let selected = [];
  HEROES.forEach(h=>{
    const d=document.createElement("div");
    d.className="hero-choice";
    d.textContent=h;
    d.onclick=()=>{
      if(selected.includes(h) || selected.length>=4) return;
      selected.push(h);
      d.classList.add("selected");
      if(selected.length===4) placeHeroes(selected);
    };
    heroSelect.appendChild(d);
  });
}

function placeHeroes(list){
  overlay.style.display="none";

  const slots=[0,1,2,3].sort(()=>Math.random()-0.5);
  list.forEach((h,i)=>{
    heroGrid[slots[i]].innerHTML =
      `<img src="images/${h.toLowerCase()}.jpg">`;
  });

  openHistoire(); // ouverture automatique
}

/* ===== CADRE DORÃ‰ ALÃ‰ATOIRE (ENNEMIS + HÃ‰ROS) ===== */

/* cadres actifs ennemis (hors 5e de chaque ligne) */
const enemyActive = [...document.querySelectorAll(".enemy-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

/* cadres actifs hÃ©ros (hors 5e) */
const heroActive = [...document.querySelectorAll(".hero-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

/* tirage alÃ©atoire */
const enemyGoldIndex = Math.floor(Math.random()*enemyActive.length);
const heroGoldIndex  = Math.floor(Math.random()*heroActive.length);

/* application */
enemyActive[enemyGoldIndex].classList.add("gold");
heroActive[heroGoldIndex].classList.add("gold");


/* ===== IMAGE DÃ‰S (5e cadre ligne 1 ennemis) ===== */
const enemyUnitsAll = document.querySelectorAll(".enemy-grid .unit");
const diceFrame = enemyUnitsAll[4]; // 5e cadre, ligne 1
diceFrame.innerHTML = '<img src="images/des.jpg" alt="dÃ©s">';


/* ===== DÃ‰PLACEMENT CADRE DORÃ‰ AU CLIC SUR LE DÃ‰ ===== */
const diceFrameStep3 = document.querySelectorAll(".enemy-grid .unit")[4];

/* cadres actifs ennemis : 8 positions (hors 5e cadres) */
const enemyActiveStep3 = [...document.querySelectorAll(".enemy-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

/* cadres actifs hÃ©ros : 4 positions */
const heroActiveStep3 = [...document.querySelectorAll(".hero-grid .unit")]
  .filter((_,i)=>(i+1)%5!==0);

/* indices courants (dÃ©tectÃ©s depuis l'Ã©tape 1) */
let enemyIndexStep3 = enemyActiveStep3.findIndex(u=>u.classList.contains("gold"));
let heroIndexStep3  = heroActiveStep3.findIndex(u=>u.classList.contains("gold"));

function paintGoldStep3(){
  enemyActiveStep3.forEach(u=>u.classList.remove("gold"));
  heroActiveStep3.forEach(u=>u.classList.remove("gold"));
  enemyActiveStep3[enemyIndexStep3].classList.add("gold");
  heroActiveStep3[heroIndexStep3].classList.add("gold");
}

function nextHeroStep3(){
  heroIndexStep3 = (heroIndexStep3 + 1) % heroActiveStep3.length;
}

function nextEnemyStep3(){
  // indices 0-3 = ligne 1, 4-7 = ligne 2
  if (enemyIndexStep3 === 3) {
    enemyIndexStep3 = 4; // fin ligne 1 -> dÃ©but ligne 2
  } else if (enemyIndexStep3 === 7) {
    enemyIndexStep3 = 0; // fin ligne 2 -> dÃ©but ligne 1
  } else {
    enemyIndexStep3 += 1;
  }
}

diceFrameStep3.onclick = ()=>{
  nextHeroStep3();
  nextEnemyStep3();
  paintGoldStep3();
};


/* ===== DÃ‰ DE SAUVEGARDE (5e cadre ligne 2 ennemis) ===== */
const enemyUnitsAllSave = document.querySelectorAll(".enemy-grid .unit");
const saveFrame = enemyUnitsAllSave[9]; // 5e cadre ligne 2

let saveValue = 0;

saveFrame.classList.add("save-box");
saveFrame.innerHTML = `
  <div class="save-title">DÃ‰ DE SAUVEGARDE</div>
  <div class="save-controls">
    <button type="button" id="save-minus">âˆ’</button>
    <div class="save-count" id="save-count">0</div>
    <button type="button" id="save-plus">+</button>
  </div>
`;

const saveCountEl = document.getElementById("save-count");
function updateSave(val){
  saveValue = Math.max(0, Math.min(6, val));
  saveCountEl.textContent = saveValue;
}
document.getElementById("save-plus").onclick = ()=>updateSave(saveValue+1);
document.getElementById("save-minus").onclick = ()=>updateSave(saveValue-1);


/* ===== LIEN NOUVEAU TOUR -> -1 DÃ‰ DE SAUVEGARDE ===== */
const originalDiceHandler = diceFrameStep3.onclick;

diceFrameStep3.onclick = ()=>{
  // rÃ©duire le dÃ© de sauvegarde
  if (saveValue > 0) {
    saveValue -= 1;
    saveCountEl.textContent = saveValue;
  }

  // conserver le comportement existant (dÃ©placement cadres dorÃ©s)
  if (typeof originalDiceHandler === "function") {
    originalDiceHandler();
  }
};


/* ===== TRÃ‰SOR (5e cadre ligne 3 - HÃ‰ROS) ===== */
const heroUnitsAll = document.querySelectorAll(".hero-grid .unit");
const treasureFrame = heroUnitsAll[4]; // 5e cadre hÃ©ros
treasureFrame.innerHTML = '<img src="images/tresor.jpg" alt="trÃ©sor">';
treasureFrame.style.cursor = "pointer";

// ===== TIRAGE CARTE TRÃ‰SOR =====
treasureFrame.addEventListener("click", async function(){

  const book = localStorage.getItem("hq_book");
  const num  = localStorage.getItem("hq_quest_num");
  if(!book || !num) return;

  try{
    const res = await fetch("tresor.csv");
    if(!res.ok) return;

    const text = await res.text();
    const lines = text.split("
").filter(l=>l.trim() !== "");

    let validCards = [];

    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(";");
      if(cols.length < 3) continue;

      const imgName = cols[0].trim();
      const csvBook = cols[1].trim();
      const csvQuest = cols[2].trim();

      let bookMatch = false;

      if(csvBook.toLowerCase() === "all"){
        bookMatch = true;
      }
      else if(csvBook.includes(",")){
        const bookList = csvBook.split(",").map(b=>b.trim());
        if(bookList.includes(book)) bookMatch = true;
      }
      else{
        if(csvBook === book) bookMatch = true;
      }

      if(!bookMatch) continue;

      let questMatch = false;

      if(csvQuest.toLowerCase() === "all"){
        questMatch = true;
      }
      else if(csvQuest.includes(",")){
        const questList = csvQuest.split(",").map(q=>q.trim());
        if(questList.includes(num)) questMatch = true;
      }
      else{
        if(csvQuest === num) questMatch = true;
      }

      if(questMatch){
        validCards.push(imgName);
      }
    }

    if(validCards.length === 0){
      console.warn("Aucune carte trÃ©sor valide trouvÃ©e.");
      return;
    }

    const randomIndex = Math.floor(Math.random() * validCards.length);
    const chosenImage = validCards[randomIndex];

    openTreasureModal(chosenImage);

  }catch(e){
    console.error("Erreur chargement tresor.csv", e);
  }

});

// ===== MODALE TRÃ‰SOR =====
function openTreasureModal(imageName){

  let modal = document.getElementById("treasureModal");

  if(!modal){
    modal = document.createElement("div");
    modal.id = "treasureModal";
    modal.style.position = "fixed";
    modal.style.inset = "0";
    modal.style.background = "rgba(0,0,0,0.8)";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.style.zIndex = "10100";

    modal.innerHTML = `
      <div style="
        background:#141418;
        border:3px solid var(--gold);
        border-radius:14px;
        padding:20px;
      ">
        <img id="treasureImage"
             style="max-width:80vw; max-height:80vh; border-radius:10px;">
      </div>
    `;

    document.body.appendChild(modal);

    modal.addEventListener("click", function(e){
      if(e.target === modal){
        modal.style.display = "none";
      }
    });
  }

  const img = modal.querySelector("#treasureImage");
  img.src = "cartes/" + imageName + ".jpg";

  modal.style.display = "flex";
}

// ===== CONTEXTE QUÃŠTE (reÃ§u depuis page 1) =====
const HQ_BOOK  = localStorage.getItem("hq_book");
const HQ_NUM   = localStorage.getItem("hq_quest_num");
const HQ_TITLE = localStorage.getItem("hq_quest_title");


// ===== LECTURE CSV MONSTRE ERRANT =====
(async function(){
  const book  = localStorage.getItem("hq_book");
  const num   = localStorage.getItem("hq_quest_num");

  if(!book || !num) return;

  try{
    const res = await fetch("monstre.csv");
    if(!res.ok) return;

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");

    // ignore header
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(";");
      if(cols.length < 4) continue;

      const csvBook = cols[0].trim();
      const csvNum  = cols[1].trim();
      const csvText = cols[3].trim();

      if(csvBook === book && csvNum === num){
        const target = document.getElementById("monster-text");
        if(target){
          target.textContent = csvText;
        }
        break;
      }
    }
  }catch(e){
    // silence volontaire
  }
})();


// ===== MONSTRE ERRANT : LECTURE CSV =====
(async function(){
  const book = localStorage.getItem("hq_book");
  const num  = localStorage.getItem("hq_quest_num");
  if(!book || !num) return;

  try{
    const res = await fetch("monstre.csv");
    if(!res.ok) return;
    const txt = await res.text();
    const lines = txt.split(/\r?\n/).filter(l=>l.trim()!=="");

    for(let i=1;i<lines.length;i++){ // ignore header
      const cols = lines[i].split(";");
      if(cols.length < 4) continue;
      if(cols[0].trim() === book && cols[1].trim() === num){
        const target = document.getElementById("monster-text");
        if(target) target.textContent = cols[3].trim();
        break;
      }
    }
  }catch(e){}
})();





// ===== NOTES : OUVERTURE MODALE AU CLIC (TEXTE COL 6) =====
document.addEventListener("click", function(e){
  const modal = document.getElementById("noteModal");
  const title = document.getElementById("noteModalTitle");
  if(!modal || !title) return;

  // clic sur une note
  if(
  e.target.classList &&
  e.target.classList.contains("note-square") &&
  e.target.closest("#notes-slots")
){
    title.textContent = "NOTE " + e.target.textContent;

    // supprimer l'ancien texte si prÃ©sent
    const old = title.nextElementSibling;
    if(old && old.classList && old.classList.contains("modal-text")) old.remove();

    const txt = (e.target.dataset && e.target.dataset.text) ? e.target.dataset.text : "";
    if(txt){
      const div = document.createElement("div");
      div.className = "modal-text";
      
      
      
      
      
      
      
      
      div.textContent = txt;
      title.after(div);
    }

    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
  }

  // clic hors de la fenÃªtre
  if(e.target.id === "noteModal"){
    modal.style.display = "none";
  }
});












window.validatedObjectives = new Set();

// ===== NOTES AVEC CONDITIONS (VERSION CORRIGÃ‰E STABLE) =====
(async function(){

  const book = localStorage.getItem("hq_book");
  const num  = localStorage.getItem("hq_quest_num");
  if(!book || !num) return;

  const container = document.getElementById("notes-slots");
  if(!container) return;

  const key = `hq_notes_read__${book}__${num}`;

  let validatedNotes = new Set();
  let allNotes = [];

  try{
    const saved = JSON.parse(sessionStorage.getItem(key) || "[]");
    saved.forEach(n => validatedNotes.add(n));
  }catch(e){}

  try{
    const res = await fetch("quetenote.csv");
    if(!res.ok) return;

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");

    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(";");
      if(cols.length < 4) continue;

      const csvBook = cols[0].trim();
      const csvNum  = cols[1].trim();
      const letter  = cols[3].trim();
      const condition = (cols[4] || "").trim();
      const noteTxt = (cols[5] || "").trim();

      if(csvBook === book && csvNum === num && letter){
        allNotes.push({
          letter,
          condition,
          text: noteTxt,
          order: i
        });
      }
    }

    render();
    window.forceRenderNotes = render;

  }catch(e){}

  function conditionMet(condition){
    if(!condition) return true;

    const required = condition
      .split(",")
      .map(c=>c.trim())
      .filter(Boolean);

    return required.every(c => {

      if(c.startsWith("OBJ")){
        const num = c.replace("OBJ","");
        return window.validatedObjectives.has(num);
      }

      return validatedNotes.has(c);

    });
  }

  function computeVisibleNotes(){

    let visible = new Set();
    let changed = true;

    while(changed){
      changed = false;

      for(const note of allNotes){
        if(visible.has(note.letter)) continue;

        if(conditionMet(note.condition)){
          visible.add(note.letter);
          changed = true;
        }
      }
    }

    return visible;
  }

  function render(){

    const visible = computeVisibleNotes();

    container.innerHTML = "";

    const ordered = allNotes
      .filter(n => visible.has(n.letter))
      .sort((a,b)=>a.order - b.order);

    for(const note of ordered){

      const d = document.createElement("div");
      d.className = "note-square";
      d.textContent = note.letter;
      d.dataset.letter = note.letter;
      if(note.text) d.dataset.text = note.text;

      if(validatedNotes.has(note.letter)){
        d.classList.add("read");
      }

      container.appendChild(d);
    }
  }

  document.addEventListener("click", function(e){

    if(
      e.target.classList &&
      e.target.classList.contains("note-square") &&
      e.target.closest("#notes-slots")
    ){

      const letter = e.target.dataset.letter;

      if(!validatedNotes.has(letter)){
        validatedNotes.add(letter);
        sessionStorage.setItem(key, JSON.stringify([...validatedNotes]));
      }

      render();
    window.forceRenderNotes = render;
    }

  });

})();

// ===== OBJECTIFS : LECTURE CSV (NUMÃ‰RO + TEXTE COLONNE 6) =====
(async function(){
  const book = localStorage.getItem("hq_book");
  const num  = localStorage.getItem("hq_quest_num");
  if(!book || !num) return;

  const container = document.getElementById("objectifs-slots");
  if(!container) return;

  try{
    const res = await fetch("queteobjectif.csv");
    if(!res.ok) return;

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");

    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(";");
      if(cols.length < 4) continue;

      const csvBook = cols[0].trim();
      const csvNum  = cols[1].trim();
      const objNum  = cols[3].trim();
      const objTxt  = (cols.length >= 6 ? cols[5].trim() : "");

      if(csvBook === book && csvNum === num && objNum){
        const d = document.createElement("div");
        d.className = "objective-square";
        d.textContent = objNum;
        if(objTxt) d.dataset.text = objTxt;
        container.appendChild(d);
      }
    }
  }catch(e){}
})();















// ===== OBJECTIFS : OUVERTURE + FERMETURE PROPRE =====
document.addEventListener("click", function(e){

  const modal = document.getElementById("objectifModal");
  const title = document.getElementById("objectifModalTitle");
  if(!modal || !title) return;

  // ouverture
  if(
    e.target.classList &&
    e.target.classList.contains("objective-square") &&
    e.target.closest("#objectifs-slots")
  ){

    title.textContent = "OBJECTIF " + e.target.textContent;

    const old = modal.querySelector(".modal-text");
    if(old) old.remove();

    const txt = e.target.dataset.text || "";
    if(txt){
      const div = document.createElement("div");
      div.className = "modal-text";
      div.style.marginTop = "20px";
      div.style.whiteSpace = "pre-line";
      div.textContent = txt;
      title.after(div);
    }

    
    const objNum = e.target.textContent.trim();
    if(!window.validatedObjectives.has(objNum)){
      window.validatedObjectives.add(objNum);
    }

    e.target.classList.add("read-objective");
    if(window.forceRenderNotes) window.forceRenderNotes();
    modal.style.display = "block";
    document.getElementById("objectifBox").classList.add("objectif-open");
  }

  // fermeture
  if(e.target.id === "objectifModal"){
    modal.style.display = "none";
    document.getElementById("objectifBox").classList.remove("objectif-open");
  }
});



// ===== NOTE MODALE =====
const noteModal = document.getElementById("noteModal");
if(noteModal){
  noteModal.addEventListener("click", function(e){
    if(e.target === noteModal){
      noteModal.style.display = "none";
    }
  });
}

// ===== OBJECTIF MODALE =====
const objectifModal = document.getElementById("objectifModal");
if(objectifModal){
  objectifModal.addEventListener("click", function(e){
    if(e.target === objectifModal){
      objectifModal.style.display = "none";
    }
  });
}



// ===== HISTOIRE : FONCTION PROPRE =====
async function openHistoire(){

  const book = localStorage.getItem("hq_book");
  const num  = localStorage.getItem("hq_quest_num");
  if(!book || !num) return;

  const modal = document.getElementById("histoireModal");
  const box   = document.getElementById("histoireBox");
  const title = document.getElementById("histoireTitle");

  if(!modal || !box || !title) return;

  title.textContent = "QUÃŠTE";

  const old = box.querySelector(".modal-text");
  if(old) old.remove();

  try{
    const res = await fetch("histoire.csv");
    if(!res.ok) return;

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");

    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(";");
      if(cols.length < 5) continue;

      if(cols[0].trim() === book && cols[1].trim() === num){

        const div = document.createElement("div");
        div.className = "modal-text";
        div.style.marginTop = "20px";
        div.style.whiteSpace = "pre-line";
        div.textContent = cols[4].trim();

        box.appendChild(div);
        break;
      }
    }

  }catch(e){}

  modal.style.display = "flex";
}

document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("btn-histoire");
  if(btn){
    btn.onclick = openHistoire;
  }
});

const histoireModal = document.getElementById("histoireModal");
if(histoireModal){
  histoireModal.addEventListener("click", function(e){
    if(e.target === histoireModal){
      histoireModal.style.display = "none";
    }
  });
}



document.addEventListener("DOMContentLoaded", function(){

  const histoireClose = document.getElementById("histoireClose");
  const histoireModal = document.getElementById("histoireModal");

  if(histoireClose && histoireModal){
    histoireClose.addEventListener("click", function(e){
      e.stopPropagation();
      histoireModal.style.display = "none";
    });
  }

});
</script>

<!-- FIN DE QUÃŠTE : MODALE MINIMALE -->
<div id="fin-quete-modal" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="
    background:#141418;
    border:1px solid var(--gold);
    border-radius:14px;
    padding:16px;
    width:min(900px,90vw);
  ">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <a href="index.html"><img src="images/livre.jpg" style="width:100%;border-radius:10px;cursor:pointer"></a>
      <a href="index_page_3.html"><img src="images/ville.jpg" style="width:100%;border-radius:10px;cursor:pointer"></a>
    </div>
    <div style="text-align:center">
      <button class="btn hq-btn"
        onclick="document.getElementById('fin-quete-modal').style.display='none'">
        Continuer la quÃªte
      </button>
    </div>
  </div>
</div>


<!-- NOTE MODALE SIMPLE -->
<div id="noteModal" style="
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.7);
  z-index:10050;
">
  <div style="
    background:#141418;
    border:1px solid var(--gold);
    border-radius:12px;
    padding:18px 22px;
    font-family:'Cinzel Decorative','Uncial Antiqua',serif;
    color:var(--gold);
    letter-spacing:2px;
  ">
    <div id="noteModalTitle">NOTE</div>
  </div>
</div>


<!-- OBJECTIF MODALE -->
<div id="objectifModal" style="
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,0.9);
  z-index:10060;
">

  <div id="objectifBox" style="
    position:absolute;
    left:0;
    top:50%;
    transform:translateY(-50%);
    width:50vw;
    background:#141418;
    border-right:2px solid var(--gold);
    padding:40px;
  ">

    <h2 id="objectifModalTitle" style="margin-top:0;">
      OBJECTIF
    </h2>

  </div>
</div>


<!-- HISTOIRE MODALE -->
<div id="histoireModal" style="
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.75);
  z-index:10070;
">

  <div id="histoireBox" style="
    background:#141418;
    border:3px solid #8b1a1a;
    box-shadow:0 0 30px rgba(139,26,26,.6);
    border-radius:14px;
    padding:40px;
    width:min(900px,80vw);
    max-height:80vh;
    overflow:auto;
    color:var(--gold);
    font-family:'HeroQuestCustom', serif;
  ">

    <div style="display:flex; justify-content:space-between; align-items:center;">
  <h2 id="histoireTitle" style="margin:0;">
    QUÃŠTE
  </h2>
  <div id="histoireClose" style="
    cursor:pointer;
    font-size:22px;
    color:var(--gold);
    padding:4px 10px;
    border-radius:6px;
  ">âœ•</div>
</div>

  </div>
</div>

</body>
</html>
